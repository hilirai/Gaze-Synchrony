<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Scribble Prompt</title>
  <style>
    canvas { border:1px solid #000; cursor: crosshair; }
    body { font-family: sans-serif; text-align: center; }
    #controls { margin: 10px; }
    #err { color: #b00; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h3>Draw Positive (green) or Negative (red) Scribbles</h3>
  <p>Left-click+drag: positive • Right-click+drag: negative • Click <strong>Send</strong> when done.</p>

  <div id="err"></div>

  <!-- Canvas for drawing; background seeded with the grid image -->
  <canvas id="cv"></canvas>

  <div id="controls">
    <button onclick="sendStrokes()">Send</button>
    <button onclick="reloadImg()">Reload image</button>
    <span id="status"></span>
  </div>

  <script>
    const canvas = document.getElementById("cv");
    const ctx = canvas.getContext("2d");
    const statusEl = document.getElementById("status");
    const errEl = document.getElementById("err");

    // Keep strokes in outer scope so buttons can access them
    let drawing = false, mode = "pos";
    const strokes = { pos: [], neg: [] };
    let current = null;

    function drawBackground() {
      const img = new Image();
      // Cache-buster to avoid stale image
      img.src = "/static/seed_grid.jpg?v=" + Date.now();
      img.onload = () => {
        errEl.textContent = "";
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
      };
      img.onerror = () => {
        errEl.textContent = "Could not load /static/seed_grid.jpg. Make sure your analyzer wrote it into the Flask static folder.";
      };
    }

    function setupDrawing() {
      canvas.onmousedown = e => {
        e.preventDefault();
        drawing = true;
        mode = (e.button === 2) ? "neg" : "pos";
        current = [];
        strokes[mode].push(current);
      };
      canvas.onmousemove = e => {
        if (!drawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        current.push([x, y]);
        ctx.fillStyle = (mode === "pos") ? "green" : "red";
        ctx.fillRect(x, y, 2, 2);
      };
      canvas.onmouseup = () => { drawing = false; };
      canvas.onmouseleave = () => { drawing = false; };
      canvas.oncontextmenu = e => e.preventDefault();
    }

    function sendStrokes() {
      fetch("/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(strokes)
      })
      .then(r => r.json())
      .then(() => { statusEl.textContent = "✔ sent"; })
      .catch(() => { statusEl.textContent = "✖ send failed"; });
    }

    function reloadImg() {
      statusEl.textContent = "";
      drawBackground();
    }

    // Initialize
    drawBackground();
    setupDrawing();
    window.sendStrokes = sendStrokes;
    window.reloadImg = reloadImg;
  </script>
</body>
</html>
